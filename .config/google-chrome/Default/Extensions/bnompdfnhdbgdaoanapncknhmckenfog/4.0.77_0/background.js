function Feed_item(s){if(s&&s.data&&s.data.email)switch(s.data.a){case"view":case"view_link":Storage_get("notifications_disabled",function(o){Storage_get("feed_mute",function(e){e&&~e.indexOf(s.data.email)||Storage_get("settings",function(n){n=n||{},Storage_get("cache_emails",function(e){var t="";if(e)for(var i in e)s.data.user==e[i]&&(t=i);Storage_get("feed",function(a){a=a||[],Storage_get("feed_unopened",function(r){r=r||[],Storage_get("feed_clicks",function(e){e=e||[];var i=0;try{a.forEach(function(e,t){if(e&&e.id_source===s.data.email)throw a[t]=null,i=1,{}})}catch(e){}a.push({id_source:s.data.email,id:s.data.id_email,time:s.data.time,views:s.data.views,user:t}),Storage_update("feed",a);try{r.forEach(function(e,t){if(e.id_source===s.data.email)throw r.splice(t,1),{}})}catch(e){}Storage_update("feed_unopened",r),s.data.link&&(e.push({id_source:s.data.email,id:s.data.id_email,time:s.data.time,user:t,link:s.data.link}),Storage_update("feed_clicks",e)),Storage_update("feed_updated","1"),o||(chrome.browserAction.getBadgeText({},function(e){chrome.browserAction.setBadgeText({text:String(e?parseInt(e)+1:1)})}),n.notifications_desktop&&(!i||"view"===s.data.a&&n.notifications_extra_all||"view_link"===s.data.a&&n.notifications_extra_links)&&Storage_get("feed_info",function(e){function i(){(r=r||{}).subject||(r.subject="An email");var i=r.link||Tracker_email_link(s.data.email,t,s.data.id_email);chrome.notifications.create("",{type:"basic",title:s.data.link?'"'+s.data.link+'" was clicked on "'+r.subject+'"':'"'+r.subject+'" was opened',message:"Click to view email or reply",contextMessage:r.to?r.to[0]+(r.to[1]?" +"+(r.to.length-1)+" More":""):r.email,isClickable:!0,iconUrl:"image/icon.png"},function(t){chrome.notifications.onClicked.addListener(function(e){t===e&&(i?chrome.tabs.create({url:i}):(Error_report(411),alert(__("error_feed_info"))))})})}var r=(e=e||{})[s.data.email];r?i():Xtion_request(LOCATION_ACTION+"email_information_get",function(t){t&&Storage_get("feed_info",function(e){e=e||{},(r=JSON.parse(t)).to=r.to.split(", "),e[s.data.email]=r,Storage_update("feed_info",e)}),i()},{post:{email:s.data.id_email}})})),n.notifications_desktop&&(!i||"view"===s.data.a&&n.notifications_extra_all||"view_link"===s.data.a&&n.notifications_extra_links)||Storage_get("user_pro",function(e){e&&Storage_get("feed_info",function(e){(e=e||{})[s.data.email]||Xtion_request(LOCATION_ACTION+"email_information_get",function(t){t&&Storage_get("feed_info",function(e){(e=e||{})[s.data.email]=JSON.parse(t),e[s.data.email].to=e[s.data.email].to.split(", "),Storage_update("feed_info",e)})},{post:{email:s.data.id_email}})})}),chrome.windows.getAll({populate:!0},function(e){e.forEach(function(e){e.tabs.forEach(function(t){chrome.runtime.getManifest().content_scripts[0].matches.forEach(function(e){~t.url.indexOf(e.replace("*://*.","").replace("/*",""))&&chrome.tabs.executeScript(t.id,{code:"for(var ee=document.querySelectorAll('.emailtracker_status[data-id=\""+s.data.email.replace(/'/g,"").replace(/"/g,"")+'"]\'),l=ee.length;l--;){var e=ee[l];e.removeChild(e.firstChild);e.insertAdjacentHTML("afterBegin","&#10003;");e.setAttribute("data-status",1);if(e.firstElementChild){e.firstElementChild.removeAttribute("data-emailtracker")}}',allFrames:!0})})})})})})})})})})})})}else Error_report(800,"Missing GCM message id_source",JSON.stringify(s.data),null,{debug_report:1})}function Feed_sync(){Storage_get("user_pro",function(e){window.feed_sync_delay_skip++,(e||4<=window.feed_sync_delay_skip)&&(window.feed_sync_delay_skip=0,Storage_get("feed_unopened",function(e){if(e){e=e.reverse();for(var t=[],i=0;i<e.length&&i<200;i++)e[i].id&&t.push({id:e[i].id,id_source:e[i].id_source});t.length&&Xtion_request(LOCATION_ACTION+"sync_email_ids",function(e){(e=JSON.parse(e))&&e.length&&e.forEach(function(e){Feed_item({data:Xtion_object_merge({a:"view"},e)})})},{post:{emails:t},timeout:3e4})}}))})}window.BACKGROUND=1,chrome.runtime.onMessage.addListener(function(e,t,i){switch(e.a){case"request":return e.options.error&&(e.options.error=function(e){i({a:"error",e:e})}),Xtion_request(e.url,i,e.options),!0;case"cookie":return chrome.cookies.get(e.details,function(e){i(e?e.value:null)}),!0;case"cookie_set":return chrome.cookies.set(e.details,i),!0;case"activated":chrome.browserAction.setIcon({path:"image/icon.38.png",tabId:t.tab.id});break;case"badge_clear":chrome.browserAction.setBadgeText({text:""});break;case"background_storage_set":localStorage.setItem(e.key,e.value),i&&i();break;case"feed_sync":Feed_sync();break;case"alive":return i(1),!0}}),chrome.webRequest.onBeforeRequest.addListener(function(e){try{for(var t=localStorage.getItem("email_ids"),i=t?JSON.parse(t):[],r=i.length;r--;)for(var a in LOCATION_TRACKERS_V)if(~e.url.indexOf(LOCATION_TRACKERS_V[a]+"?u="+i[r]+"&")||~e.url.indexOf(encodeURIComponent(LOCATION_TRACKERS_V[a]+"?u="+i[r]+"&")))return{cancel:!0}}catch(i){Error_report(850,i)}if(DEBUG&&~e.url.indexOf("googleusercontent.com")&&~e.url.indexOf("#")&&~e.url.indexOf("=48573&"))for(var n in LOCATION_TRACKERS_V)if(0===e.url.split("#",2)[1].indexOf(LOCATION_TRACKERS_V[n]))return{redirectUrl:e.url.split("#",2)[1]}},{urls:["*://*.googleusercontent.com/*","*://*.yusercontent.com/*","*://*.outlook.com/proxy/*","*://*.office.net/imageproxy/*"].concat(window.LOCATION_TRACKERS.map(function(e){return e+"*"}))},["blocking"]),chrome.webRequest.onErrorOccurred.addListener(function(e){!e.error||~e.url.indexOf("email_view.gif")||"https://emailtracker.website/a/sync_email_ids"===e.url||~e.url.indexOf("https://emailtracker.website/a/user_emails")||~e.url.indexOf("https://emailtracker.website/a/emails")||["net::ERR_ABORTED","net::ERR_NETWORK_CHANGED","net::ERR_INTERNET_DISCONNECTED","net::ERR_CONNECTION_RESET","net::ERR_CONNECTION_CLOSED","net::ERR_NETWORK_IO_SUSPENDED","net::ERR_NETWORK_ACCESS_DENIED"].indexOf(e.error)},{urls:["*://*.emailtracker.website/*"]}),chrome.runtime.onInstalled.addListener(function(e){"install"===e.reason?TESTING||window.open(LOCATION_MAIN+"instructions"):"update"===e.reason&&parseFloat(e.previousVersion)<2.92&&chrome.cookies.remove({url:LOCATION_ACTION,name:"user"})}),chrome.runtime.setUninstallURL(LOCATION_MAIN+"uninstall?version="+encodeURIComponent(chrome.runtime.getManifest().version)),chrome.windows.getAll({populate:!0},function(e){e.forEach(function(e){e.tabs.forEach(function(t){chrome.runtime.getManifest().content_scripts[0].matches.forEach(function(e){~t.url.indexOf(e.replace("*://*.","").replace("/*",""))&&chrome.tabs.executeScript(t.id,{code:'!!document.querySelector("html[data-emailtracker-initialized]")',allFrames:!0},function(e){e&&!e[0]&&(chrome.runtime.getManifest().content_scripts[0].js.forEach(function(e){chrome.tabs.executeScript(t.id,{file:e,allFrames:!0})}),chrome.runtime.getManifest().content_scripts[0].css.forEach(function(e){chrome.tabs.insertCSS(t.id,{file:e,allFrames:!0})}))})})})})}),chrome.webRequest.onBeforeSendHeaders.addListener(function(r){if(r.initiator==="chrome-extension://"+chrome.runtime.id){var a=[];r.requestHeaders.forEach(function(t,e){var i=0;"x-specify-user-agent"===t.name.toLowerCase()?(r.requestHeaders.forEach(function(e){"user-agent"===e.name.toLowerCase()&&(i=1,e.value=t.value)}),i||r.requestHeaders.push({name:"User-Agent",value:t.value}),a.push(e)):"x-specify-origin"===t.name.toLowerCase()&&(r.requestHeaders.forEach(function(e){"origin"===e.name.toLowerCase()&&(i=1,e.value=t.value)}),i||r.requestHeaders.push({name:"Origin",value:t.value}),a.push(e))});for(var e=a.length;e--;)r.requestHeaders.splice(a[e],1)}return{requestHeaders:r.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"]),function i(){Storage_get("notify",function(e){e||chrome.instanceID.getToken({authorizedEntity:PUSH_GCM_ID,scope:"GCM"},function(t){chrome.runtime.lastError?(window.notifications_register_retry?window.notifications_register_retry++:window.notifications_register_retry=1,window.notifications_register_retry<5&&setTimeout(function(){i()},1e3*window.notifications_register_retry)):Xtion_request(LOCATION_ACTION+"notification_register",function(e){"{"===e.substr(0,1)?Storage_update("notify",Xtion_object_merge(JSON.parse(e),{push:t})):Error_report(601,e)},{post:{id:t},retry:3})})})}(),window.feed_sync_delay_skip=0,chrome.gcm.onMessage.addListener(Feed_item),chrome.gcm.onMessagesDeleted.addListener(Feed_sync),Feed_sync(),setInterval(Feed_sync,9e5),chrome.runtime.onConnect.addListener(function(e){e.onMessage.addListener(function(e){})});
